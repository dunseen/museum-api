name: Add SSH Key to VPS

on:
  workflow_dispatch:
    inputs:
      public_key:
        description: 'SSH Public Key to add (paste your id_rsa.pub content)'
        required: true
        type: string

jobs:
  add-ssh-key:
    name: Add SSH Key to VPS
    runs-on: ubuntu-latest
    steps:
      - name: Set up SSH Connection
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Add new SSH key to VPS
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.VPS_HOST }} << 'EOF'
          set -e

          NEW_KEY="${{ inputs.public_key }}"

          # Check if key already exists
          if grep -qF "$NEW_KEY" ~/.ssh/authorized_keys; then
            echo "âš ï¸  Key already exists in authorized_keys"
          else
            # Add the new key
            echo "$NEW_KEY" >> ~/.ssh/authorized_keys
            echo "âœ… SSH key added successfully!"
          fi

          # Show the last few keys (for verification)
          echo ""
          echo "ğŸ“ Last 3 entries in authorized_keys:"
          tail -n 3 ~/.ssh/authorized_keys
          EOF

      - name: Test new SSH connection
        run: |
          echo "âœ… SSH key was added successfully!"
          echo "ğŸ”‘ You can now connect to the VPS with your new private key"
